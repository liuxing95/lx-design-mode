# 代理模式

## 1. 概念

代理模式（Proxy Pattern）又被称为委托模式， 它为目标对象创造了一个代理模式 以控制对目标对象的访问  

代理模式把代理对象插入到访问者和目标对象之间，从而为访问者对目标对象的访问引入一定的间接性。正是这种间接性，给了代理对象很多操作空间，比如在调用目标对象前和调用后进行一些预操作和后操作，从而实现新的功能或者扩展目标的功能。

1.  Target： 目标对象，也是被代理对象，是具体业务的实际执行者；
2.  Proxy： 代理对象，负责引用目标对象，以及对访问的过滤和预处理；

ES6 也提供了 `Proxy`对象 这个构造函数 可以让我们很方便的构建代理对象
```
var proxy = new Proxy(target, handler);
```




## 2.  你曾见过的代理模式

在类似的场景中，有以下特点：
1. 导演/法院（访问者）对明星/当事人（目标）的访问都是通过经纪人/律师（代理）来完成；
2. 经纪人/律师（代理）对访问有过滤的功能；


## 3.  代理模式在实战中的应用

- 3.1 拦截器
  拦截器的思想在实战中应用非常多，比如我们在项目中经常使用 Axios 的实例来进行 HTTP 的请求，使用拦截器 interceptor 可以提前对 request 请求和 response 返回进行一些预处理，比如：

  1.  request 请求头的设置，和 Cookie 信息的设置；
  2.  权限信息的预处理，常见的比如验权操作或者 Token 验证；
  3.  数据格式的格式化，比如对组件绑定的 Date 类型的数据在请求前进行一些格式约定好的序列化操作；
  4.  空字段的格式预处理，根据后端进行一些过滤操作；
  5.  response 的一些通用报错处理，比如使用 Message 控件抛出错误；

  拦截器看起来似乎和装饰者模式很像，但是要注意装饰者模式和代理模式的区别，代理模式控制访问者对目标对象的访问，而装饰者模式只给目标对象添加功能，原有功能不变且可直接使用。


  Axios 拦截器是可以取消请求的，vue-router 路由拦截器也可以进行路由截停和重定向等等复杂操作，这些场景下，无疑是代理模式，因为这里的拦截器控制了对目标对象的访问，如果没有进行访问控制而只进行消息预处理和后处理，那么则可以当作是装饰者模式。



- 3.2 前端框架的数据响应式
  现在的很多前端框架或者状态管理框架都使用上面介绍的 Object.defineProperty 和 Proxy 来实现数据的响应式化，比如 Vue、Mobx、AvalonJS 等，Vue 2.x 与 AvalonJS 使用前者，而 Vue 3.x 与 Mobx 5.x 使用后者。


- 3.3 缓存代理

- 3.4 保护代理 和 虚拟代理
  1.  保护代理： 当一个对象可能会收到大量请求时，可以设置保护代理，通过一些条件判断对请求进行过滤；
  2.  虚拟代理：在程序中可以能有一些代价昂贵的操作，此时可以设置虚拟代理，虚拟代理会在适合的时候才执行操作。

  保护代理其实就是对访问的过滤，之前的经纪人例子就属于这种类型。
  而虚拟代理是为一个开销很大的操作先占位，之后再执行，比如：
  1. 一个很大的图片加载前，一般使用菊花图、低质量图片等提前占位，优化图片加载导致白屏的情况；
  2. 现在很流行的页面加载前使用骨架屏来提前占位，很多 WebApp 和 NativeApp 都采用这种方式来优化用户白屏体验；


- 3.5 正向代理与反向代理
  1. 正向代理： 一般的访问流程是客户端直接向目标服务器发送请求并获取内容，使用正向代理后，客户端改为向代理服务器发送请求，并指定目标服务器（原始服务器），然后由代理服务器和原始服务器通信，转交请求并获得的内容，再返回给客户端。正向代理隐藏了真实的客户端，为客户端收发请求，使真实客户端对服务器不可见；
  2. 反向代理： 与一般访问流程相比，使用反向代理后，直接收到请求的服务器是代理服务器，然后将请求转发给内部网络上真正进行处理的服务器，得到的结果返回给客户端。反向代理隐藏了真实的服务器，为服务器收发请求，使真实服务器对客户端不可见。


## 代理模式的优缺点

代理模式的主要优点有：
1. 代理对象在访问者与目标对象之间可以起到中介和保护目标对象的作用；
2. 代理对象可以扩展目标对象的功能；
3. 代理模式能将访问者与目标对象分离，在一定程度上降低了系统的耦合度，如果我们希望适度扩展目标对象的一些功能，通过修改代理对象就可以了，符合开闭原则；
代理模式的缺点主要是增加了系统的复杂度，要斟酌当前场景是不是真的需要引入代理模式（十八线明星就别请经纪人了）。